#!/bin/bash

# SSL Monitor Pro - Cloudflare Pages Setup for GitLab Migration
# Usage: ./scripts/setup-cloudflare.sh

echo "‚òÅÔ∏è  Configuring Cloudflare Pages for GitLab Migration..."
echo "====================================================="

# Load secrets
if [ -f ".migration-secrets" ]; then
    source .migration-secrets
else
    echo "‚ùå Error: .migration-secrets file not found!"
    exit 1
fi

echo ""
echo "üìã Current Cloudflare Pages Configuration:"
echo "   ‚Ä¢ Project: ssl-monitor-pro"
echo "   ‚Ä¢ URL: https://cloudsre.xyz"
echo "   ‚Ä¢ Current Source: GitHub (root/ssl-monitor-pro)"
echo "   ‚Ä¢ Target Source: GitLab (root/ssl-monitor-pro)"
echo ""

echo "üîß Configuration Options:"
echo ""
echo "1Ô∏è‚É£ Option A: Direct GitLab Integration (Recommended)"
echo "   ‚Ä¢ Connect Cloudflare Pages directly to GitLab"
echo "   ‚Ä¢ Automatic builds on every push"
echo "   ‚Ä¢ Built-in preview deployments"
echo ""
echo "2Ô∏è‚É£ Option B: GitLab CI/CD Upload (Current Setup)"
echo "   ‚Ä¢ Use Wrangler CLI from GitLab pipeline"
echo "   ‚Ä¢ Manual control over build process"
echo "   ‚Ä¢ Custom build commands"
echo ""

echo "üöÄ Recommended: Option A - Direct GitLab Integration"
echo ""
echo "üìã Manual Configuration Steps:"
echo ""
echo "1Ô∏è‚É£ Cloudflare Dashboard Setup:"
echo "   ‚Ä¢ Go to: https://dash.cloudflare.com"
echo "   ‚Ä¢ Navigate to: Pages ‚Üí ssl-monitor-pro"
echo "   ‚Ä¢ Go to: Settings ‚Üí Build & Deploy"
echo ""
echo "2Ô∏è‚É£ Disconnect Current Source:"
echo "   ‚Ä¢ Click: 'Disconnect' next to GitHub"
echo "   ‚Ä¢ Confirm disconnection"
echo ""
echo "3Ô∏è‚É£ Connect to GitLab:"
echo "   ‚Ä¢ Click: 'Connect to Git'"
echo "   ‚Ä¢ Select: GitLab"
echo "   ‚Ä¢ Repository: root/ssl-monitor-pro"
echo "   ‚Ä¢ Branch: main"
echo ""
echo "4Ô∏è‚É£ Build Configuration:"
echo "   ‚Ä¢ Build command: npm run build"
echo "   ‚Ä¢ Build output directory: frontend-modern/dist"
echo "   ‚Ä¢ Root directory: frontend-modern"
echo "   ‚Ä¢ Environment variables: (if needed)"
echo ""
echo "5Ô∏è‚É£ Custom Domain:"
echo "   ‚Ä¢ Ensure cloudsre.xyz is still connected"
echo "   ‚Ä¢ SSL/TLS: Full (strict)"
echo ""

echo "üîß Alternative: Option B - GitLab CI/CD Upload"
echo ""
echo "üìã Current GitLab CI/CD Configuration:"
echo "   ‚Ä¢ Uses Wrangler CLI"
echo "   ‚Ä¢ API Token: Already in GitLab Variables"
echo "   ‚Ä¢ Project Name: ssl-monitor-pro"
echo ""
echo "üìù GitLab CI/CD Job (already configured):"
echo "   deploy-frontend:"
echo "     stage: deploy"
echo "     image: node:18-alpine"
echo "     before_script:"
echo "       - npm install -g wrangler"
echo "     script:"
echo "       - cd frontend-modern"
echo "       - npm ci"
echo "       - npm run build"
echo "       - npx wrangler pages publish dist --project-name=ssl-monitor-pro"
echo ""

echo "üß™ Testing Current Configuration:"
echo ""
echo "1Ô∏è‚É£ Check API Token:"
echo "   ‚Ä¢ Token: $CLOUDFLARE_API_TOKEN"
echo "   ‚Ä¢ Account ID: $CLOUDFLARE_ACCOUNT_ID"
echo ""
echo "2Ô∏è‚É£ Test Wrangler Authentication:"
echo "   npx wrangler whoami"
echo ""
echo "3Ô∏è‚É£ Manual Deploy Test:"
echo "   cd frontend-modern"
echo "   npm run build"
echo "   npx wrangler pages publish dist --project-name=ssl-monitor-pro"
echo ""

echo "üìä Expected Results:"
echo "   ‚Ä¢ Build completes successfully"
echo "   ‚Ä¢ Files uploaded to Cloudflare Pages"
echo "   ‚Ä¢ Site accessible at https://cloudsre.xyz"
echo "   ‚Ä¢ Custom domain working"
echo ""

echo "‚ö†Ô∏è  Important Notes:"
echo "   ‚Ä¢ Test both options before deciding"
echo "   ‚Ä¢ Option A is easier for ongoing maintenance"
echo "   ‚Ä¢ Option B gives more control"
echo "   ‚Ä¢ Keep backup of current configuration"
echo ""

echo "üîç Verification Steps:"
echo "   1. Check current site: https://cloudsre.xyz"
echo "   2. Verify SSL certificate"
echo "   3. Test all pages load correctly"
echo "   4. Check build logs in Cloudflare"
echo ""

echo "‚úÖ Cloudflare Pages Configuration Complete!"
echo ""
echo "üìã Next Steps:"
echo "   1. Choose integration method (A or B)"
echo "   2. Complete manual configuration"
echo "   3. Test deployment"
echo "   4. Verify custom domain"
echo "   5. Proceed to webhook verification"
echo ""
echo "üîó Links:"
echo "   ‚Ä¢ Cloudflare Dashboard: https://dash.cloudflare.com"
echo "   ‚Ä¢ Pages Project: ssl-monitor-pro"
echo "   ‚Ä¢ Production URL: https://cloudsre.xyz"
echo "   ‚Ä¢ GitLab Variables: http://192.168.1.10/root/ssl-monitor-pro/-/settings/ci_cd"
